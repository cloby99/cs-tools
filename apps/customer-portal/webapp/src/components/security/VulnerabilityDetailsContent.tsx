// Copyright (c) 2026 WSO2 LLC. (https://www.wso2.com).
//
// WSO2 LLC. licenses this file to you under the Apache License,
// Version 2.0 (the "License"); you may not use this file except
// in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.

import {
  Box,
  Button,
  Card,
  CardContent,
  Chip,
  IconButton,
  Paper,
  Stack,
  Typography,
} from "@wso2/oxygen-ui";
import { ArrowLeft, Shield, Package, Code, ExternalLink } from "@wso2/oxygen-ui-icons-react";
import { type JSX } from "react";
import type { ProductVulnerability } from "@models/responses";
import {
  getVulnerabilitySeverityColor,
  getVulnerabilityStatusColor,
} from "@utils/vulnerabilities";
import ErrorIndicator from "@components/common/error-indicator/ErrorIndicator";
import VulnerabilityDetailsSkeleton from "@components/security/VulnerabilityDetailsSkeleton";

const NVD_BASE_URL = "https://nvd.nist.gov/vuln/detail";

export interface VulnerabilityDetailsContentProps {
  data: ProductVulnerability | undefined;
  isLoading: boolean;
  isError: boolean;
  onBack: () => void;
}

/**
 * VulnerabilityDetailsContent displays vulnerability header and detail cards.
 *
 * @param {VulnerabilityDetailsContentProps} props - Data, loading/error state, and callbacks.
 * @returns {JSX.Element} The rendered vulnerability details content.
 */
export default function VulnerabilityDetailsContent({
  data,
  isLoading,
  isError,
  onBack,
}: VulnerabilityDetailsContentProps): JSX.Element {
  const cveId = data?.cveId ?? "--";
  const severityLabel = data?.severity?.label ?? "--";
  const statusLabel = data?.status?.label;
  const vulnerabilityId = data?.vulnerabilityId ?? "--";
  const severityColor = getVulnerabilitySeverityColor(severityLabel);
  const statusColor = statusLabel
    ? getVulnerabilityStatusColor(statusLabel)
    : undefined;

  if (isLoading) {
    return (
      <Box
        sx={{
          display: "flex",
          flexDirection: "column",
          flex: 1,
          minHeight: 0,
          overflow: "hidden",
        }}
      >
        <Paper
          variant="outlined"
          sx={{
            p: 2,
            flexShrink: 0,
            zIndex: 10,
            borderRadius: 0,
          }}
        >
          <Stack direction="row" alignItems="center" gap={2}>
            <IconButton onClick={onBack} size="small" aria-label="Back">
              <ArrowLeft size={20} />
            </IconButton>
            <Box
              sx={{
                p: 1,
                bgcolor: "warning.lighter",
                color: "warning.main",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
              }}
            >
              <Shield size={24} />
            </Box>
            <Box>
              <Typography variant="h5" color="text.primary" fontWeight={600}>
                {cveId}
              </Typography>
              <Typography variant="body2" color="text.secondary">
                Vulnerability details
              </Typography>
            </Box>
          </Stack>
        </Paper>
        <Box
          sx={{
            flex: 1,
            minHeight: 0,
            overflow: "auto",
            p: 3,
            pt: 2,
          }}
        >
          <VulnerabilityDetailsSkeleton />
        </Box>
      </Box>
    );
  }

  return (
    <Box
      sx={{
        display: "flex",
        flexDirection: "column",
        flex: 1,
        minHeight: 0,
        overflow: "hidden",
      }}
    >
      <Paper
        variant="outlined"
        sx={{
          p: 2,
          flexShrink: 0,
          zIndex: 10,
          borderRadius: 0,
        }}
      >
        <Stack direction="row" alignItems="center" gap={2} sx={{ mb: isError ? 0 : 2 }}>
          <IconButton onClick={onBack} size="small" aria-label="Back">
            <ArrowLeft size={20} />
          </IconButton>

          {isError ? (
            <Box
              sx={{
                display: "flex",
                alignItems: "center",
                gap: 1.5,
                py: 2,
              }}
            >
              <ErrorIndicator entityName="vulnerability details" size="medium" />
              <Box>
                <Typography variant="body1" color="error" fontWeight={500}>
                  Failed to load vulnerability details
                </Typography>
                <Typography variant="caption" color="text.secondary">
                  Something went wrong while fetching the information.
                </Typography>
              </Box>
            </Box>
          ) : (
            <>
              <Box
                sx={{
                  p: 1,
                  bgcolor: "warning.lighter",
                  color: "warning.main",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                }}
              >
                <Shield size={24} />
              </Box>
              <Box>
                <Typography variant="h5" color="text.primary" fontWeight={600}>
                  {cveId}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Vulnerability details
                </Typography>
              </Box>
            </>
          )}
        </Stack>
      </Paper>

      {!isError && data && (
        <Box
          sx={{
            flex: 1,
            minHeight: 0,
            overflow: "auto",
            p: 3,
            pt: 2,
          }}
        >
          <Stack spacing={3}>
            {/* Main details card */}
            <Card variant="outlined">
              <CardContent sx={{ p: 3, "&:last-child": { pb: 3 } }}>
                <Stack spacing={3}>
                  <Box
                    sx={{
                      display: "flex",
                      flexDirection: { xs: "column", md: "row" },
                      justifyContent: "space-between",
                      alignItems: { xs: "flex-start", md: "center" },
                      gap: 2,
                    }}
                  >
                    <Box>
                      <Stack
                        direction="row"
                        spacing={1}
                        alignItems="center"
                        flexWrap="wrap"
                        useFlexGap
                      >
                        <Typography
                          variant="h6"
                          color="text.primary"
                          fontWeight={600}
                        >
                          {cveId}
                        </Typography>
                        <Chip
                          label={severityLabel}
                          size="small"
                          variant="outlined"
                          sx={{
                            color: severityColor,
                            borderColor: severityColor,
                            fontWeight: 500,
                          }}
                        />
                        {statusLabel && (
                          <Chip
                            label={statusLabel}
                            size="small"
                            variant="outlined"
                            sx={{
                              color: statusColor ?? "text.secondary",
                              borderColor: statusColor ?? "divider",
                              fontWeight: 500,
                            }}
                          />
                        )}
                      </Stack>
                      <Typography
                        variant="body2"
                        color="text.secondary"
                        sx={{ mt: 0.5 }}
                      >
                        {vulnerabilityId}
                      </Typography>
                    </Box>
                    {data.cveId && (
                      <Button
                        component="a"
                        href={`${NVD_BASE_URL}/${data.cveId}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        variant="outlined"
                        size="small"
                        startIcon={<ExternalLink size={16} />}
                      >
                        NVD
                      </Button>
                    )}
                  </Box>
                </Stack>
              </CardContent>
            </Card>

            {/* Component Information card */}
            <Card variant="outlined">
              <CardContent sx={{ p: 3, "&:last-child": { pb: 3 } }}>
                <Stack spacing={3}>
                  <Stack direction="row" alignItems="center" spacing={1}>
                    <Box
                      sx={{
                        color: "warning.main",
                        display: "flex",
                        alignItems: "center",
                      }}
                    >
                      <Package size={20} />
                    </Box>
                    <Typography variant="h6" color="text.primary" fontWeight={600}>
                      Component Information
                    </Typography>
                  </Stack>

                  <Box
                    sx={{
                      display: "grid",
                      gridTemplateColumns: {
                        xs: "1fr",
                        md: "1fr 1fr",
                      },
                      gap: 3,
                    }}
                  >
                    <Box>
                      <Typography
                        variant="caption"
                        color="text.secondary"
                        sx={{ display: "block", mb: 0.5 }}
                      >
                        Component Name
                      </Typography>
                      <Typography
                        variant="body2"
                        color="text.primary"
                        sx={{ wordBreak: "break-all" }}
                      >
                        {data.componentName || "--"}
                      </Typography>
                    </Box>
                    <Box>
                      <Typography
                        variant="caption"
                        color="text.secondary"
                        sx={{ display: "block", mb: 0.5 }}
                      >
                        Component Version
                      </Typography>
                      <Typography variant="body2" color="text.primary">
                        {data.version || "--"}
                      </Typography>
                    </Box>
                    <Box>
                      <Typography
                        variant="caption"
                        color="text.secondary"
                        sx={{ display: "block", mb: 0.5 }}
                      >
                        Component Type
                      </Typography>
                      <Chip
                        label={data.type || data.componentType || "--"}
                        size="small"
                        variant="outlined"
                      />
                    </Box>
                    {data.updateLevel && (
                      <Box>
                        <Typography
                          variant="caption"
                          color="text.secondary"
                          sx={{ display: "block", mb: 0.5 }}
                        >
                          Update Level
                        </Typography>
                        <Typography variant="body2" color="text.primary">
                          {data.updateLevel}
                        </Typography>
                      </Box>
                    )}
                  </Box>
                </Stack>
              </CardContent>
            </Card>

            {/* Resolution & Mitigation card */}
            <Card variant="outlined">
              <CardContent sx={{ p: 3, "&:last-child": { pb: 3 } }}>
                <Stack spacing={3}>
                  <Stack direction="row" alignItems="center" spacing={1}>
                    <Box
                      sx={{
                        color: "warning.main",
                        display: "flex",
                        alignItems: "center",
                      }}
                    >
                      <Code size={20} />
                    </Box>
                    <Typography variant="h6" color="text.primary" fontWeight={600}>
                      Resolution & Mitigation
                    </Typography>
                  </Stack>

                  <Box
                    sx={{
                      display: "grid",
                      gridTemplateColumns: {
                        xs: "1fr",
                        md: "1fr 1fr",
                      },
                      gap: 3,
                    }}
                  >
                    <Box>
                      <Typography
                        variant="caption"
                        color="text.secondary"
                        sx={{ display: "block", mb: 0.5 }}
                      >
                        Use Case
                      </Typography>
                      <Typography variant="body2" color="text.primary">
                        {data.useCase ?? "Not Applicable"}
                      </Typography>
                    </Box>
                    <Box>
                      <Typography
                        variant="caption"
                        color="text.secondary"
                        sx={{ display: "block", mb: 0.5 }}
                      >
                        Component Type
                      </Typography>
                      <Chip
                        label={data.componentType || data.type || "--"}
                        size="small"
                        variant="outlined"
                      />
                    </Box>
                  </Box>

                  {data.justification && (
                    <Box>
                      <Typography
                        variant="caption"
                        color="text.secondary"
                        sx={{ display: "block", mb: 1 }}
                      >
                        Justification
                      </Typography>
                      <Box
                        sx={{
                          p: 2,
                          bgcolor: "action.hover",
                          border: "1px solid",
                          borderColor: "divider",
                        }}
                      >
                        <Typography variant="body2" color="text.primary">
                          {data.justification}
                        </Typography>
                      </Box>
                    </Box>
                  )}

                  {data.resolution && (
                    <Box>
                      <Typography
                        variant="caption"
                        color="text.secondary"
                        sx={{ display: "block", mb: 1 }}
                      >
                        Resolution
                      </Typography>
                      <Box
                        sx={{
                          p: 2,
                          bgcolor: "info.lighter",
                          border: "1px solid",
                          borderColor: "info.main",
                        }}
                      >
                        <Typography variant="body2" color="text.primary">
                          {data.resolution}
                        </Typography>
                      </Box>
                    </Box>
                  )}

                  {!data.justification && !data.resolution && (
                    <Typography variant="body2" color="text.secondary">
                      No justification or resolution information available.
                    </Typography>
                  )}
                </Stack>
              </CardContent>
            </Card>
          </Stack>
        </Box>
      )}
    </Box>
  );
}
